<!DOCTYPE html>
<html class="no-js" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base.html}">

<body>
<!--	content layout start  -->
<div id="fh5co-main" layout:fragment="content">
    <!-- Modal -->
    <div class="modal eventRegisterModal" tabindex="-1">
        <div class="modal-dialog" style="width: 80%; max-width: 1000px; ">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>공연/전시 추가</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <!-- 테이블 추가 -->
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                            <tr>
                                <th style="width: 15%;">썸네일</th>
                                <th style="width: 10%;">Event ID</th>
                                <th style="width: 15%;">제목</th>
                                <th style="width: 13%;">공연 시작일</th>
                                <th style="width: 13%;">공연 종료일</th>
                                <th style="width: 15%;">지역</th>
                                <th style="width: 14%;">장르</th>
                                <th style="width: 5%;">추가</th>
                            </tr>
                            </thead>
                            <tbody id="eventList">
                            </tbody>
                        </table>
                    </div>
                    <!-- 페이지 네비게이션 버튼 -->
                    <div id="paginationContainer" class="d-flex justify-content-between mt-3">
                        <!-- 이전 페이지 버튼 -->
                        <button id="prevPageBtn" class="btn btn-outline-secondary" disabled>이전</button>
                        <div class="d-flex align-items-center justify-content-center flex-grow-1">
                            <span id="pageButtons" class="mx-3 text-center">Page 1</span>
                            <input type="text" id="pageInput" class="page-input form-control mx-2" min="1" placeholder="Page 검색" style="width: 125px;">
                        </div>
                        <!-- 다음 페이지 버튼 -->
                        <button id="nextPageBtn" class="btn btn-outline-secondary">다음</button>
                    </div>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="fh5co-narrow-content animate-box" data-animate-effect="fadeInLeft" style="padding-bottom: 0px;">
        <div class="row">
            <div class="col-md-4">
                <h2>공연 등록</h2>
            </div>
        </div>
        <form action="#" method="get" th:action="@{/event/search}" th:object="${eventSearchDTO}">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="perform-name">공연 이름</label>
                        <input type="text" class="form-control" name="perform-name" id="perform-name" placeholder="공연 이름">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="location-code">지역 코드</label>
                        <select id="location-code" class="form-control" name="location-code">
                            <option value="">지역 선택</option>
                            <option value="11">서울</option>
                            <option value="26">부산</option>
                            <option value="27">대구</option>
                            <option value="28">인천</option>
                            <option value="29">광주</option>
                            <option value="30">대전</option>
                            <option value="31">울산</option>
                            <option value="36">세종</option>
                            <option value="41">경기</option>
                            <option value="51">강원</option>
                            <option value="43">충북</option>
                            <option value="44">충남</option>
                            <option value="45">전북</option>
                            <option value="46">전남</option>
                            <option value="47">경북</option>
                            <option value="48">경남</option>
                            <option value="50">제주</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="start-date">공연 시작일</label>
                        <input type="date" id="start-date" name="start-date" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="end-date">공연 종료일</label>
                        <input type="date" id="end-date" name="end-date" class="form-control">
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group">
                        <button type="button" class="btn btn-primary btn-md searchEventBtn">검색</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="fh5co-narrow-content animate-box" data-animate-effect="fadeInLeft">
        <div class="row">
            <div class="col-md-12">
                <h2>등록된 공연 목록</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                    <tr>
                        <th style="width: 10%;">썸네일</th>
                        <th style="width: 10%;">Event ID</th>
                        <th style="width: 20%;">제목</th>
                        <th style="width: 15%;">공연 시작일</th>
                        <th style="width: 15%;">공연 종료일</th>
                        <th style="width: 15%;">지역</th>
                        <th style="width: 15%;">장르</th>
                        <th style="width: 10%;">삭제</th>
                    </tr>
                    </thead>
                    <tbody id="savedEventList">

                    </tbody>
                </table>
                <ul class="pagination replyPaging">
                    <!-- 페이징 번호가 여기에 동적으로 추가됩니다 -->
                </ul>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>
<!--	content layout end  -->

<!-- JavaScript -->

<th:block layout:fragment="javascript">
    <script th:src="@{/js/event/event.js}"></script>
    <script th:inline="javascript"></script>

    <script>
        // 이벤트 목록을 출력하는 함수
        function printEventList(dtoList) {
            // 동적으로 추가될 HTML을 저장할 변수
            let str = "";

            // dtoList가 존재하고 길이가 0 이상인 경우
            if (dtoList && dtoList.length > 0) {
                // 이벤트 목록을 순회하며 테이블에 넣을 행을 동적으로 생성
                dtoList.forEach(dto => {
                    str += `
                <tr>
                    <!-- 썸네일 이미지 -->
                    <td><img src="${dto.poster}" alt="Thumbnail" style="width: 50px; height: 50px;"></td>

                    <!-- Event ID -->
                    <td>${dto.eventId}</td>

                    <!-- 제목 -->
                    <td>${dto.title}</td>

                    <!-- 공연 시작일 -->
                    <td>${dto.prfpdfrom}</td>

                    <!-- 공연 종료일 -->
                    <td>${dto.prfpdto}</td>

                    <!-- 지역 -->
                    <td>${dto.location}</td>

                    <!-- 장르 -->
                    <td>${dto.genreName}</td>

                    <!-- 삭제 버튼 -->
                    <td>
                        <button class="btn btn-danger" onclick="deleteEvent(${dto.eventId})">삭제</button>
                    </td>
                </tr>
            `;
                });
            } else {
                // 이벤트 목록이 없을 경우
                str = "<tr><td colspan='8'>이벤트가 없습니다.</td></tr>";
            }

            // 테이블 본문에 동적으로 생성된 HTML 넣기
            const savedEventList = document.getElementById("savedEventList");
            savedEventList.innerHTML = str;
        }
        // 페이징 목록 처리
        function printPages(data) {
            let pageStr = '';

            // 이전 페이지 여부
            if (data.prev) {
                pageStr += `<li class="page-item"><a class="page-link" data-page="${data.start - 1}">이전</a></li>`;
            }

            // 페이지 번호를 출력 (보통 10개씩 출력 중)
            for (let i = data.start; i <= data.end; i++) {
                pageStr += `
            <li class="${data.page == i ? 'page-item active' : 'page-item'}">
                <a class="page-link" data-page="${i}">${i}</a>
            </li>
        `;
            }

            // 다음 페이지 여부
            if (data.next) {
                pageStr += `<li class="page-item"><a class="page-link" data-page="${data.end + 1}">다음</a></li>`;
            }

            // 페이징 번호를 화면에 출력
            const replyPaging = document.querySelector('.replyPaging');
            replyPaging.innerHTML = pageStr;
        }
        // 이벤트 목록을 서버에서 받아오는 함수
        function fetchEventList(page, size) {
            // 서버로부터 이벤트 목록을 가져오는 API 호출
            fetch(`/event/savedEventList?page=${page}&size=${size}`)
                .then(response => response.json())  // JSON 형식으로 변환
                .then(data => {
                    // 받아온 데이터를 출력 함수에 전달
                    printEventList(data.dtoList); // 이벤트 목록 출력
                    printPages(data); // 페이징 출력
                })
                .catch(error => {
                    console.error('이벤트 목록을 가져오는 중 오류 발생:', error);
                });
        }
        document.addEventListener("DOMContentLoaded", function() {
            console.log("페이지 로딩됨!");
            // 초기 페이지 로드시 첫 번째 페이지의 이벤트 목록을 가져옵니다.
            fetchEventList(1, 10);
        });

        // 페이징 번호 클릭 이벤트 핸들러
        const replyPaging = document.querySelector('.replyPaging');
        let currentPage = 1;
        let pageSize = 10;

        replyPaging.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();

            const target = e.target;

            // a 태그가 아니면, 이벤트 처리를 안합니다.
            if (!target || target.tagName !== 'A') {
                return;
            }

            // 페이지 번호 가져오기
            const pageNum = target.getAttribute("data-page");
            currentPage = pageNum;  // 현재 페이지 번호 업데이트

            // 해당 페이지의 이벤트 목록을 가져옵니다.
            fetchEventList(currentPage, pageSize);
        });

        // 이벤트 삭제 함수
        function deleteEvent(eventId) {
            if (confirm(`이벤트 ${eventId}를 삭제하시겠습니까?`)) {
                fetch(`/event/deleteEvent/${eventId}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        alert('삭제 성공');
                        // 삭제 후 이벤트 목록을 다시 불러와서 업데이트
                        fetchEventList(currentPage, pageSize);
                    })
                    .catch(error => {
                        console.error('삭제 실패:', error);
                        alert('삭제 실패');
                    });
            }
        }






    </script>
</th:block>
</body>
</html>
